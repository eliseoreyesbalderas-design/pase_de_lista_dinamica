<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asistencia Inteligente ‚Ä¢ Conteo + Checklist</title>
  <meta name="description" content="App web para pasar lista: cuenta personas/rostros con la c√°mara o fotos y genera checklist desde CSV." />
  <style>
    :root{
      --brand:#2563eb; --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626; --bg:#0f172a; --card:#111827;
      --muted:#94a3b8; --ring:#334155;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:linear-gradient(135deg,#0f172a,#1f2937); color:#e5e7eb}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;gap:14px;align-items:center;margin-bottom:16px}
    header h1{font-size:clamp(20px,3.2vw,28px);margin:0}
    header .badge{font-size:12px;background:#0ea5e9;color:#001; padding:4px 8px;border-radius:999px;font-weight:700}

    .grid{display:grid;gap:16px; grid-template-columns:1.1fr .9fr}
    @media (max-width:950px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--ring); border-radius:14px; overflow:hidden}
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--ring);font-size:16px;background:#0b1220}
    .card .content{padding:14px 16px}

    .stack{display:flex;flex-wrap:wrap;gap:10px}
    button, .btn{appearance:none; cursor:pointer;border:1px solid #334155;background:#0b1220;color:#e5e7eb; padding:10px 14px;border-radius:10px;font-weight:600}
    button:hover{border-color:#475569}
    .pri{background:var(--brand); border-color:transparent;color:white}
    .ok{background:var(--ok); border-color:transparent}
    .bad{background:var(--bad); border-color:transparent}
    .muted{background:#111827}
    .ghost{background:transparent}
    .pill{border-radius:999px}
    .hidden{display:none!important}

    .video-wrap{position:relative;background:#0b1220;border-radius:10px; overflow:hidden;border:1px solid var(--ring)}
    video, canvas{display:block;width:100%}
    video{height:min(60vh,420px);object-fit:cover}
    canvas{position:absolute; inset:0; pointer-events:none}

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .grow{flex:1}

    .kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
    @media (max-width:700px){.kpi{grid-template-columns:repeat(2,1fr)}}
    .kpi .tile{background:#0b1220;border:1px solid var(--ring);border-radius:12px;padding:12px}
    .kpi .n{font-size:28px;font-weight:800}
    .kpi small{color:var(--muted)}

    .list{max-height:52vh; overflow:auto; display:grid; gap:8px}
    .item{display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center; background:#0b1220;border:1px solid var(--ring); border-radius:10px; padding:10px}
    .item input[type="checkbox"]{transform:scale(1.2)}
    .name{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .badge{padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .present{background:rgba(22,163,74,.15); color:#86efac; border:1px solid rgba(22,163,74,.35)}
    .absent{background:rgba(220,38,38,.15); color:#fecaca; border:1px solid rgba(220,38,38,.35)}

    input[type="file"]{display:none}
    label.file{border:1px dashed #334155; padding:10px 14px;border-radius:10px; cursor:pointer}
    input[type="range"]{width:160px}

    .foot{color:#94a3b8; font-size:12px; margin-top:8px}
    .note{padding:10px; background:#0b1220;border:1px solid var(--ring); border-radius:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üìã Asistencia Inteligente</h1>
      <span class="badge">v3</span>
    </header>

    <div class="grid">
      <!-- C√ÅMARA / FOTO -->
      <section class="card">
        <h2>üé• Conteo autom√°tico</h2>
        <div class="content">
          <div class="row" style="gap:12px">
            <div class="row" style="gap:6px">
              <strong>Modelo:</strong>
              <label><input type="radio" name="model" value="people" checked /> Personas (COCO‚ÄëSSD)</label>
              <label><input type="radio" name="model" value="faces" /> Rostros (BlazeFace)</label>
            </div>
            <div class="row" style="gap:6px">
              <strong>Umbral:</strong>
              <input id="th" type="range" min="0" max="100" value="50" />
              <span id="thv">50%</span>
            </div>
          </div>

          <div class="video-wrap" id="vw">
            <video id="video" playsinline autoplay muted></video>
            <canvas id="overlay"></canvas>
          </div>

          <div class="row" style="margin-top:10px">
            <button class="pri" id="startCam">Iniciar c√°mara</button>
            <button class="bad" id="stopCam" disabled>Detener c√°mara</button>
            <button class="muted" id="snap" disabled>Capturar</button>
            <input id="photoFile" type="file" accept="image/*" />
            <label for="photoFile" class="file">üì∑ Detectar desde foto</label>
          </div>

          <div class="kpi" style="margin-top:12px">
            <div class="tile"><div class="n" id="kDetected">0</div><small>Detectados</small></div>
            <div class="tile"><div class="n" id="kStudents">0</div><small>En lista</small></div>
            <div class="tile"><div class="n" id="kPresent">0</div><small>Presentes</small></div>
            <div class="tile"><div class="n" id="kAbsent">0</div><small>Ausentes</small></div>
          </div>

          <div id="msg" class="foot"></div>
        </div>
      </section>

      <!-- CHECKLIST / CSV -->
      <section class="card">
        <h2>üìù Lista y CSV</h2>
        <div class="content">
          <div class="row">
            <input id="csvFile" type="file" accept=".csv" />
            <label for="csvFile" class="file">üìÑ Cargar alumnos (.csv)</label>
            <button id="downloadTpl" class="ghost">Descargar plantilla</button>
            <input id="search" placeholder="Buscar‚Ä¶" class="grow" style="padding:10px;border-radius:10px;border:1px solid var(--ring); background:#0b1220;color:#e5e7eb" />
          </div>

          <div class="row" style="margin-top:8px">
            <button id="markAll" class="ok">Marcar todos</button>
            <button id="clearAll" class="muted">Limpiar marcas</button>
            <button id="saveLocal" class="muted">Guardar local</button>
            <button id="loadLocal" class="ghost">Cargar guardado</button>
            <button id="exportCsv" class="pri">Exportar asistencia CSV</button>
          </div>

          <div class="list" id="list"></div>

          <div class="note" style="margin-top:10px">
            <b>C√≥mo usar:</b> 1) Carga la <i>lista de alumnos</i> desde un CSV (columna ¬´Nombre¬ª obligatoria, ¬´ID¬ª opcional). 2) Usa el conteo autom√°tico como referencia. 3) Marca presentes en la lista y exporta el reporte.
          </div>
        </div>
      </section>
    </div>

    <p class="foot">Todo el procesamiento ocurre localmente en tu navegador. Para mejor rendimiento usa Chrome/Edge en HTTPS.
    </p>
  </div>

  <!-- Librer√≠as (CDN confiables y versionadas) -->
  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
  <!-- Modelos: COCO-SSD y BlazeFace -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7/dist/blazeface.min.js"></script>
  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
  // ====== Estado ======
  const el = (id)=>document.getElementById(id);
  const video = el('video');
  const canvas = el('overlay');
  const ctx = canvas.getContext('2d');
  const msg = el('msg');

  let stream = null;
  let loopReq = null;
  let activeModel = 'people'; // 'people' | 'faces'
  let coco = null, blaze = null;
  let threshold = 0.5; // 0..1
  let detectedCount = 0;

  let students = []; // {id,name,present}

  // ====== Util ======
  const setMsg = (t)=> msg.textContent = t || '';
  const fmtPct = (x)=> Math.round(x*100)+'%';

  function resizeCanvasToVideo(){
    if(!video.videoWidth) return;
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
  }

  function updateKPIs(){
    const total = students.length;
    const present = students.filter(s=>s.present).length;
    el('kDetected').textContent = detectedCount;
    el('kStudents').textContent = total;
    el('kPresent').textContent = present;
    el('kAbsent').textContent = Math.max(0,total-present);
  }

  function renderList(filter=''){
    const list = el('list');
    list.innerHTML = '';
    const q = filter.trim().toLowerCase();
    students.forEach((s,i)=>{
      if(q && !s.name.toLowerCase().includes(q) && !(s.id||'').toLowerCase().includes(q)) return;
      const row = document.createElement('div');
      row.className = 'item';
      row.innerHTML = `
        <input type="checkbox" ${s.present?'checked':''} aria-label="${s.name}" />
        <div class="name">${s.id?`<small style='color:var(--muted)'>${s.id}</small> ¬∑ `:''}${s.name}</div>
        <span class="badge ${s.present?'present':'absent'}">${s.present?'Presente':'Ausente'}</span>`;
      const cb = row.querySelector('input');
      const badge = row.querySelector('.badge');
      cb.addEventListener('change',()=>{
        s.present = cb.checked;
        badge.textContent = s.present?'Presente':'Ausente';
        badge.className = 'badge ' + (s.present?'present':'absent');
        updateKPIs();
      });
      list.appendChild(row);
    });
    updateKPIs();
  }

  function loadCSVFile(file){
    return new Promise((resolve,reject)=>{
      Papa.parse(file,{
        header:true, skipEmptyLines:true, encoding:'utf-8',
        complete:(res)=>{
          try{
            const rows = res.data;
            const out = [];
            rows.forEach(r=>{
              const name = (r.Nombre||r.NOMBRE||r.name||r.Name||'').toString().trim();
              const id = (r.ID||r.Id||r.id||'').toString().trim();
              if(name) out.push({id, name, present:false});
            });
            if(!out.length) throw new Error('No se encontr√≥ columna "Nombre" con datos.');
            resolve(out);
          }catch(e){reject(e)}
        },
        error:(err)=>reject(err)
      });
    });
  }

  function downloadTemplate(){
    const csv = 'ID,Nombre\n2023001,Ana P√©rez\n2023002,Carlos L√≥pez\n';
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'plantilla_alumnos.csv';
    document.body.appendChild(a); a.click(); a.remove();
  }

  function exportAttendance(){
    const now = new Date();
    const date = now.toLocaleDateString('es-ES');
    const time = now.toLocaleTimeString('es-ES');
    let csv = 'Reporte de Asistencia\n';
    csv += `Fecha,${date}\nHora,${time}\nDetectados,${detectedCount}\n\n`;
    csv += 'ID,Nombre,Estado,Fecha,Hora\n';
    students.forEach(s=>{
      csv += `${JSON.stringify(s.id||'')},${JSON.stringify(s.name)},${s.present?'Presente':'Ausente'},${date},${time}\n`;
    });
    const present = students.filter(s=>s.present).length;
    csv += `\nRESUMEN\nTotal,${students.length}\nPresentes,${present}\nAusentes,${students.length-present}\nAsistencia,${students.length?((present/students.length*100).toFixed(1)+'%'):'0%'}\n`;
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `asistencia_${now.toISOString().replace(/[:.]/g,'-')}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
  }

  function saveLocal(){
    const data = {ts:Date.now(), students, detectedCount};
    localStorage.setItem('asistencia_guardado', JSON.stringify(data));
    setMsg('‚úÖ Asistencia guardada localmente');
    setTimeout(()=>setMsg(''),2000);
  }
  function loadLocal(){
    const raw = localStorage.getItem('asistencia_guardado');
    if(!raw){ setMsg('‚ÑπÔ∏è No hay guardados'); return; }
    try{
      const data = JSON.parse(raw);
      students = (data.students||[]).map(s=>({id:s.id||'', name:s.name||'', present:!!s.present}));
      renderList(el('search').value);
      setMsg('‚úÖ Cargado');
      setTimeout(()=>setMsg(''),1500);
    }catch(e){ setMsg('‚ùå Error cargando datos'); }
  }

  // ====== Detecci√≥n ======
  async function ensureModels(){
    if(!coco){ coco = await cocoSsd.load({base:'lite_mobilenet_v2'}); }
    if(!blaze){ blaze = await blazeface.load(); }
  }

  async function startCamera(){
    try{
      await ensureModels();
      const constraints = {video:{facingMode:'environment', width:{ideal:1280}, height:{ideal:720}}};
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      await video.play();
      resizeCanvasToVideo();
      el('startCam').disabled = true; el('stopCam').disabled = false; el('snap').disabled = false;
      setMsg('üé¨ C√°mara iniciada');
      runLoop();
    }catch(e){
      console.error(e);
      setMsg('‚ùå No se pudo acceder a la c√°mara. Permisos/HTTPS requeridos.');
    }
  }

  function stopCamera(){
    if(loopReq){ cancelAnimationFrame(loopReq); loopReq = null; }
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
    el('startCam').disabled = false; el('stopCam').disabled = true; el('snap').disabled = true;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    setMsg('üì¥ C√°mara detenida');
  }

  function drawBoxes(boxes, scores){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.lineWidth = 3; ctx.font = '14px sans-serif';
    boxes.forEach((b,i)=>{
      const s = scores? scores[i] : 1;
      if(s < threshold) return;
      const [x,y,w,h] = b; // already in video pixels
      ctx.strokeStyle = 'rgba(34,197,94,0.9)';
      ctx.fillStyle = 'rgba(34,197,94,0.9)';
      ctx.strokeRect(x,y,w,h);
      const label = `${activeModel==='people'?'Persona':'Rostro'} ${Math.round(s*100)}%`;
      ctx.fillText(label, x+4, Math.max(12, y-6));
    });
  }

  async function runLoop(){
    let last = 0;
    const step = async (t)=>{
      loopReq = requestAnimationFrame(step);
      if(t - last < 120) return; // ~8 fps throttle para m√≥viles
      last = t;
      if(!video.videoWidth) return;
      resizeCanvasToVideo();
      try{
        if(activeModel==='people'){
          const preds = await coco.detect(video);
          const p = preds.filter(o=>o.class==='person');
          const boxes = p.map(o=>[o.bbox[0],o.bbox[1],o.bbox[2],o.bbox[3]]);
          const scores = p.map(o=>o.score);
          drawBoxes(boxes, scores);
          detectedCount = p.filter(o=>o.score>=threshold).length;
        }else{
          const p = await blaze.estimateFaces(video, false);
          // p[i].topLeft + bottomRight in pixels
          const boxes = p.map(f=>{
            const [x1,y1] = f.topLeft; const [x2,y2] = f.bottomRight; return [x1,y1,x2-x1,y2-y1];
          });
          const scores = p.map(f=>f.probabilities?f.probabilities[0]:1);
          drawBoxes(boxes, scores);
          detectedCount = scores.filter(s=>s>=threshold).length;
        }
      }catch(err){
        console.warn('Detect error', err);
        setMsg('‚ö†Ô∏è Detecci√≥n pausada por un error moment√°neo');
      }
      updateKPIs();
    };
    loopReq = requestAnimationFrame(step);
  }

  function captureSnapshot(){
    if(!video.videoWidth){ setMsg('‚ÑπÔ∏è La c√°mara no est√° lista'); return; }
    const tmp = document.createElement('canvas');
    tmp.width = video.videoWidth; tmp.height = video.videoHeight;
    const tctx = tmp.getContext('2d');
    tctx.drawImage(video,0,0); // frame
    tctx.drawImage(canvas,0,0); // overlay
    const a = document.createElement('a');
    a.href = tmp.toDataURL('image/png');
    a.download = `captura_${new Date().toISOString().replace(/[:.]/g,'-')}.png`;
    document.body.appendChild(a); a.click(); a.remove();
  }

  async function detectOnImage(file){
    const img = new Image();
    img.onload = async ()=>{
      // Mostrar imagen en el <video> contenedor
      stopCamera();
      video.srcObject = null; video.pause();
      // Pintar imagen en canvas de fondo usando drawImage en un canvas aparte
      // Para simplificar, ajustamos el tama√±o del canvas de overlay al de la imagen
      canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
      const bg = document.createElement('canvas');
      bg.width = img.naturalWidth; bg.height = img.naturalHeight;
      bg.getContext('2d').drawImage(img,0,0);
      // Colocamos el bitmap de fondo dentro del contenedor de video
      el('vw').style.position='relative';
      // Insertamos el canvas de fondo antes del overlay si no existe
      let old = el('bgimg');
      if(!old){
        old = document.createElement('canvas');
        old.id = 'bgimg';
        old.style.position = 'absolute'; old.style.inset = 0; old.style.width='100%'; old.style.height='100%';
        el('vw').insertBefore(old, canvas);
      }
      old.width = img.naturalWidth; old.height = img.naturalHeight;
      old.getContext('2d').drawImage(img,0,0);

      await ensureModels();
      try{
        if(activeModel==='people'){
          const preds = await coco.detect(img);
          const p = preds.filter(o=>o.class==='person');
          const boxes = p.map(o=>[o.bbox[0],o.bbox[1],o.bbox[2],o.bbox[3]]);
          const scores = p.map(o=>o.score);
          drawBoxes(boxes, scores);
          detectedCount = scores.filter(s=>s>=threshold).length;
        }else{
          const p = await blaze.estimateFaces(img, false);
          const boxes = p.map(f=>{const [x1,y1]=f.topLeft; const [x2,y2]=f.bottomRight; return [x1,y1,x2-x1,y2-y1];});
          const scores = p.map(f=>f.probabilities?f.probabilities[0]:1);
          drawBoxes(boxes, scores);
          detectedCount = scores.filter(s=>s>=threshold).length;
        }
        updateKPIs();
        setMsg('üñºÔ∏è Detecci√≥n terminada sobre la foto');
      }catch(e){ setMsg('‚ùå Error al detectar en la foto'); }
    };
    img.onerror = ()=> setMsg('‚ùå No se pudo leer la imagen');
    img.src = URL.createObjectURL(file);
  }

  // ====== Eventos UI ======
  document.addEventListener('DOMContentLoaded',()=>{
    // sliders
    el('th').addEventListener('input', (e)=>{ threshold = e.target.value/100; el('thv').textContent = Math.round(threshold*100)+'%'; });

    // modelo
    document.querySelectorAll('input[name="model"]').forEach(r=>{
      r.addEventListener('change', (e)=>{ activeModel = e.target.value; setMsg(`Modelo: ${activeModel==='people'?'COCO‚ÄëSSD':'BlazeFace'}`); });
    });

    // c√°mara
    el('startCam').addEventListener('click', startCamera);
    el('stopCam').addEventListener('click', stopCamera);
    el('snap').addEventListener('click', captureSnapshot);

    // foto
    el('photoFile').addEventListener('change', (e)=>{ if(e.target.files[0]) detectOnImage(e.target.files[0]); e.target.value=''; });

    // CSV
    el('downloadTpl').addEventListener('click', downloadTemplate);
    el('csvFile').addEventListener('change', async (e)=>{
      if(!e.target.files[0]) return;
      try{
        students = await loadCSVFile(e.target.files[0]);
        renderList(el('search').value);
        setMsg(`‚úÖ Cargados ${students.length} alumnos desde CSV`);
      }catch(err){ setMsg('‚ùå Error leyendo CSV: '+ err.message); }
      e.target.value='';
    });

    // lista
    el('search').addEventListener('input', (e)=> renderList(e.target.value));
    el('markAll').addEventListener('click', ()=>{ students.forEach(s=>s.present=true); renderList(el('search').value); });
    el('clearAll').addEventListener('click', ()=>{ students.forEach(s=>s.present=false); renderList(el('search').value); });

    // guardar / cargar / exportar
    el('saveLocal').addEventListener('click', saveLocal);
    el('loadLocal').addEventListener('click', loadLocal);
    el('exportCsv').addEventListener('click', exportAttendance);

    // seguridad / compatibilidad
    if(!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)){
      setMsg('‚ö†Ô∏è Tu navegador no soporta c√°mara (MediaDevices). A√∫n puedes cargar fotos y pasar lista.');
    }
    if(location.protocol!=='https:' && !['localhost','127.0.0.1'].includes(location.hostname)){
      setMsg('üîí Consejo: usa HTTPS para que el navegador permita la c√°mara.');
    }

    updateKPIs();
  });

  // Pausar cuando la pesta√±a no est√° visible
  document.addEventListener('visibilitychange',()=>{ if(document.hidden && loopReq){ cancelAnimationFrame(loopReq); loopReq=null; } else if(!document.hidden && stream){ runLoop(); } });
  </script>
</body>
</html>
